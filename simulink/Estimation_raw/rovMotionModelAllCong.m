function [x_dot, y] = rovMotionModelAllCong( t, x, control, ...
    m, g, rho, V, lx1, ly1, ly2, lx2, ly3, lx5, ly4, lz6, zb,...
    Kp, Kp_dot, Kp_abs_p, Mq, Mq_dot, Mq_abs_q,Nr, Nr_dot,...
    Nr_abs_r, Ix, Iy, Iz, Ix_Kp_dot, Iy_Mq_dot, Iz_Nr_dot, Ts, mag_n, mag_e, mag_d,...
    varargin)
%******* States
p = x(1);
q = x(2);
r = x(3);

quat_norm = norm(x(4:7));
n = x(4)/quat_norm;
e1 = x(5)/quat_norm;
e2 = x(6)/quat_norm;
e3 = x(7)/quat_norm;
%*******    Computed values
W = m*g;
B = W;
% look-up table for t200.
lookup =[...
  -40.0337   -1.0000
  -40.0337   -0.9750
  -40.0788   -0.9500
  -37.5428   -0.9250
  -36.6092   -0.9000
  -35.4971   -0.8750
  -33.7623   -0.8500
  -32.3835   -0.8250
  -31.2263   -0.8000
  -29.9809   -0.7750
  -28.5128   -0.7500
  -27.6234   -0.7250
  -26.5554   -0.7000
  -24.7765   -0.6750
  -23.1751   -0.6500
  -22.1522   -0.6250
  -21.3510   -0.6000
  -19.5280   -0.5750
  -18.4600   -0.5500
  -17.3480   -0.5250
  -16.1025   -0.5000
  -14.6345   -0.4750
  -13.0781   -0.4500
  -12.1877   -0.4250
  -10.9874   -0.4000
  -10.0528   -0.3750
   -8.8966   -0.3500
   -7.7404   -0.3250
   -6.8058   -0.3000
   -6.0497   -0.2750
   -5.1151   -0.2500
   -4.2698   -0.2250
   -3.4696   -0.2000
   -2.7135   -0.1750
   -1.8682   -0.1500
   -1.1121   -0.1250
   -0.5335   -0.1000
   -0.2667   -0.0750
         0   -0.0500
         0   -0.0250
         0         0
         0    0.0250
         0    0.0500
    0.5786    0.0750
    1.1121    0.1000
    1.8240    0.1250
    2.5801    0.1500
    3.4255    0.1750
    4.0923    0.2000
    5.1151    0.2250
    6.2272    0.2500
    7.0284    0.2750
    8.2739    0.3000
    9.2526    0.3250
   10.8089    0.3500
   12.2328    0.3750
   13.6558    0.4000
   14.9904    0.4250
   16.4585    0.4500
   17.7039    0.4750
   19.2161    0.5000
   20.5508    0.5250
   21.7521    0.5500
   23.6644    0.5750
   24.7324    0.6000
   26.4221    0.6250
   27.7126    0.6500
   29.6249    0.6750
   31.3156    0.7000
   32.8729    0.7250
   33.8065    0.7500
   34.2517    0.7750
   37.0534    0.8000
   38.6549    0.8250
   39.2776    0.8500
   41.1458    0.8750
   42.9257    0.9000
   44.7938    0.9250
   47.1062    0.9500
   48.0408    0.9750
   49.9531    1.0000];

forces = nakeinterp1(lookup(:,2),lookup(:,1),control');
%Thrusterforce in newtons. Lookup table returns in kgf
f1 = forces(1);
f2 = forces(2);
f3 = forces(3);
f4 = forces(4);
f5 = forces(5);
f6 = forces(6);

nu_k_1 = [... 
  ((Ts*(Kp + Kp_abs_p*abs(p)))/Ix_Kp_dot + 1)*p + ((Ts*(Iy - Iz - Mq_dot + Nr_dot))/Ix_Kp_dot)*q*r + (Ts*(f1*ly1 - f2*ly2 + f6*lz6 + B*zb*(2*e2*e3 + 2*e1*n)))/Ix_Kp_dot
 (-(Ts*(Ix - Iz - Kp_dot + Nr_dot))/Iy_Mq_dot)*p*r + ((Ts*(Mq + Mq_abs_q*abs(q)))/Iy_Mq_dot + 1)*q + (Ts*(f1*lx1 + f2*lx2 - f5*lx5 - B*zb*(2*e1*e3 - 2*e2*n)))/Iy_Mq_dot
                                     ((Ts*(Ix - Iy - Kp_dot + Mq_dot))/Iz_Nr_dot)*p*q + ((Ts*(Nr + Nr_abs_r*abs(r)))/Iz_Nr_dot + 1)*r + (Ts*(f3*ly3 - f4*ly4))/Iz_Nr_dot];

eta_k_1 = [... 
  n - (Ts*e1*p)/2 - (Ts*e2*q)/2 - (Ts*e3*r)/2 - (Ts^2*e1*p)/2 - (Ts^2*e2*q)/2 - (Ts^2*e3*r)/2
  e1 - (Ts*e3*q)/2 + (Ts*e2*r)/2 + (Ts*n*p)/2 - (Ts^2*e3*q)/2 + (Ts^2*e2*r)/2 + (Ts^2*n*p)/2
  e2 + (Ts*e3*p)/2 - (Ts*e1*r)/2 + (Ts*n*q)/2 + (Ts^2*e3*p)/2 - (Ts^2*e1*r)/2 + (Ts^2*n*q)/2
  e3 - (Ts*e2*p)/2 + (Ts*e1*q)/2 + (Ts*n*r)/2 - (Ts^2*e2*p)/2 + (Ts^2*e1*q)/2 + (Ts^2*n*r)/2];
 

x_dot = [nu_k_1; eta_k_1];


h = [...
    p
    q
    r
    (2*g)*n*e2 + (-2*g)*e1*e3
    (-2*g)*n*e1 + (-2*g)*e2*e3
    2*g*e1^2 + 2*g*e2^2 - g
    (-2*mag_d)*n*e2 + (2*mag_d)*e1*e3 + (-2*(mag_e^2 + mag_n^2)^(1/2))*e2^2 + (-2*(mag_e^2 + mag_n^2)^(1/2))*e3^2 + (mag_e^2 + mag_n^2)^(1/2)
    (2*mag_d)*n*e1 + (-2*(mag_e^2 + mag_n^2)^(1/2))*n*e3 + (2*(mag_e^2 + mag_n^2)^(1/2))*e1*e2 + (2*mag_d)*e2*e3
    (2*(mag_e^2 + mag_n^2)^(1/2))*n*e2 + (-2*mag_d)*e1^2 + (2*(mag_e^2 + mag_n^2)^(1/2))*e1*e3 + (-2*mag_d)*e2^2 + mag_d];

y = h;
end
