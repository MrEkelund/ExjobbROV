resampling_fs = 100;
ft = 30;

% filepath = fullfile('Estimation','bag','sinPa05hz05_2016-05-23-15-13-18.bag');
% start_time = 200; 
% end_time = 2100;

% filepath = fullfile('Estimation','bag','sinPA1Hz05_2016-05-23-15-25-06.bag');
% start_time = 300; 
% end_time = 2125;
% axis([0 (end_time - start_time)/resampling_fs -1.5 1.5])

% filepath = fullfile('Estimation','bag','sinAllA05Hz05_2016-05-23-15-31-03.bag');
% start_time = 300; 
% end_time = 2300;
%axis([0 (end_time - start_time)/resampling_fs -0.7 0.7])

% filepath = fullfile('Estimation','bag','sinAllA1hz05_2016-05-23-15-28-28.bag');
% start_time = 350; 
% end_time = 1200;
% axis([0 (end_time - start_time)/resampling_fs -1.3 1.3])

% filepath = fullfile('Estimation','bag','sinQA1Hz05_2016-05-23-15-27-20.bag');
% start_time = 400; 
% end_time = 2200;
% axis([0 (end_time - start_time)/resampling_fs -1.3 1.3])


% filepath = fullfile('Estimation','bag','sinQNewA05Hz05_2016-05-23-15-20-56.bag');
% start_time = 600; 
% end_time = 1800;
% axis([0 (end_time - start_time)/resampling_fs -0.8 0.8])

% filepath = fullfile('Estimation','bag','sinRA1Hz05_2016-05-23-15-23-40.bag');
% start_time = 300; 
% end_time = 1900;
% axis([0 (end_time - start_time)/resampling_fs -1.2 1.2])

% filepath = fullfile('Estimation','bag','sinRNewA05Hz05_2016-05-23-15-21-51.bag');
% start_time = 400; 
% end_time = 1200;
% axis([0 (end_time - start_time)/resampling_fs -1.2 1.2])

% filepath = fullfile('Estimation','bag','stepAlls3e10a1_2016-05-23-14-55-40.bag');
% start_time = 300; 
% end_time = 2000;
% axis([0 (end_time - start_time)/resampling_fs -0.5 1.6])

% filepath = fullfile('Estimation','bag','stepPs3e10_2016-05-23-13-53-27.bag');
% start_time = 300; 
% end_time = 2000;
% axis([0 (end_time - start_time)/resampling_fs -0.5 1.6])

% filepath = fullfile('Estimation','bag','stepQs3e10_2016-05-23-13-56-33.bag');
% start_time = 300; 
% end_time = 1900;
% axis([0 (end_time - start_time)/resampling_fs -0.5 1.6])

% filepath = fullfile('Estimation','bag','stepRs3e10_2016-05-23-13-59-06.bag');
% start_time = 1; 
% end_time = 1600;
% axis([0 (end_time - start_time)/resampling_fs -0.5 1.6])

% filepath = fullfile('Estimation','bag','constDepth_2016-05-23-15-53-10.bag');
% start_time = 700; 
% end_time = 5000;
% start_time = 5000; 
% end_time = 7960;
% axis([0 (end_time - start_time)/resampling_fs 0 3])


%%
filepath = fullfile('Estimation','bag','sinAllA1F05_2016-05-25-08-37-44.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1.5 1.5])

filepath = fullfile('Estimation','bag','sinPa1F05_2016-05-25-08-25-16.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1.6 1.6])

filepath = fullfile('Estimation','bag','sinQA1F05_2016-05-25-08-26-38.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1.5 1.5])

filepath = fullfile('Estimation','bag','sinQA05F05_2016-05-25-08-28-01.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1 1])

filepath = fullfile('Estimation','bag','sinRA1F05_2016-05-25-08-30-43.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1.6 1.6])

filepath = fullfile('Estimation','bag','sinRA05F05_2016-05-25-08-29-57.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1 1])

filepath = fullfile('Estimation','bag','stepRS3E10_2016-05-25-08-35-17.bag');
start_time = 300; 
end_time = 2300;
axis([0 (end_time - start_time)/resampling_fs -1.6 1.6])
%% attitude
filepath = fullfile('Estimation','bag','sinPhiA1F05_2016-05-25-08-47-49.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1.6 1.6])

filepath = fullfile('Estimation','bag','sinPhiA05F05_2016-05-25-08-49-50.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -1 1])

filepath = fullfile('Estimation','bag','stepPhiS3E10_2016-05-25-08-52-37.bag');
start_time = 300; 
end_time = 2300;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinThetaA05F05_2016-05-25-08-55-21.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinThetaA1F05_2016-05-25-08-54-21.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','stepThetaS3E10_2016-05-25-08-57-15.bag');
start_time = 400; 
end_time = 2200;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinPsiA1F05_2016-05-25-08-59-00.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinPsiA05F05_2016-05-25-09-00-24.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','stepPsiS3E10_2016-05-25-09-04-01.bag');
start_time = 300; 
end_time = 2400;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','stepAllAttitude_2016-05-25-09-15-24.bag');
start_time = 300; 
end_time = 1300;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinAllAttitudeA1_2016-05-25-09-13-13.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinAllAttitudeA05_2016-05-25-09-12-06.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','stepThetaPhi_2016-05-25-09-16-21.bag');
start_time = 300; 
end_time = 1800;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])
%% depth
filepath = fullfile('Estimation','bag','stepDepth_2016-05-25-09-35-06.bag');
start_time = 300; 
end_time = 2400;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','sinDepthA03F01_2016-05-25-09-39-15.bag');
start_time = 300; 
end_time = 2100;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

filepath = fullfile('Estimation','bag','ExactLin_2016-05-25-09-17-38.bag');
start_time = 400; 
end_time = 1900;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])

%% Exact
filepath = fullfile('Estimation','bag','sinDepthA05F01_2016-05-25-09-37-41.bag');
start_time = 1; 
end_time = 2550;
axis([0 (end_time - start_time)/resampling_fs -0.1 1.5])
%%    
bag = rosbag(filepath);
ref_bag = select(bag,'Topic','/reference');
ref_msgs = readMessages(ref_bag);

ref_data = zeros(size(ref_msgs,1),size(ref_msgs{1}.Data',2));
ref_time = zeros(size(ref_msgs,1),1);
for i = 1:size(ref_msgs,1)
    data = double(ref_msgs{i}.Data');
    ref_data(i,:) = data(:);
    ref_time(i) = ref_bag.MessageList{i,1};
end
ref_time_series = timeseries(ref_data, ref_time);

states_bag = select(bag,'Topic','/sensor_fusion/states');
states_msgs = readMessages(states_bag);

states_data = zeros(size(states_msgs,1),size(states_msgs{1}.Data',2));
states_time = zeros(size(states_msgs,1),1);
for i = 1:size(states_msgs,1)
    data = double(states_msgs{i}.Data');
    states_data(i,:) = data(:);
    states_time(i) = states_bag.MessageList{i,1};
end
states_time_series = timeseries(states_data, states_time);

% Syncronize the sensors
[ref_time_series, state_time_series] =...
    synchronize(ref_time_series, states_time_series,...
    'Uniform','Interval', 1/resampling_fs);
%%
ref_data = ref_time_series.data;
state_data = state_time_series.data;
time = ref_time_series.Time(start_time:end_time) - ref_time_series.Time(start_time);
legend_ent = {'\phi', '\theta', '\psi', 'p',  'q',  'r',  'd'};
legend_ent_ref = {'\phi_{ref}', '\theta_{ref}', '\psi_{ref}', 'p_{ref}', 'q_{ref}', 'r_{ref}', 'd_{ref}'};
units = {'rad', 'rad', 'rad', 'rad/s', 'rad/s', 'rad/s', 'm'};
ylabel_ent = {'Angle', 'Angle', 'Angle', 'Angle Velocity', 'Angle Velocity', 'Angle Velocity', 'Depth'};
for i=1:7
    h = figure(i);
    plot(time,[ref_data(start_time:end_time,i), state_data(start_time:end_time,i)],'LineWidth',2) % depth is 10 not 7
    h = legend({legend_ent_ref{i}, legend_ent{i}});
    set(h,'FontSize',ft);
    h = ylabel(strcat(ylabel_ent{i},'[', units{i}, ']'));
    set(h,'FontSize',ft);
    h = xlabel('Time [s]');
    set(h,'FontSize',ft);
    title(legend_ent{i})
    set(gca,'FontSize',ft)
    axis([0 (end_time - start_time)/resampling_fs -1 1.])
end
%%
%print -f1 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testSinAllPsiA05.eps'
%print -f1 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testSinAllPhiA1.eps'
%print -f1 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testStepThetaPhiThetas3e10a1.eps'
%print -f7 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testSinDepthA01F01.eps'

% print -f1 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testExactLinAttitudePhi.eps'
% print -f2 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testExactLinAttitudeTheta.eps'
% print -f3 -depsc2 '~/bin/ExjobbROV/Documents/Master/fig/testExactLinAttitudePsi.eps'