\chapter{Modelling the ROV} \label{cha:modelling}
This chapter will describe how our \abbrROV is modelled using \citet{fossen2011} 6 \abbrDOF model for \abbrROV's.

A underwater vehicle with 6 \abbrDOF, like our ROV, can be described by\index{Model of an underwater vehicle}
\begin{equation} \label{eq:model}
 \inertia \nuVectordot + \coriolis(\nuVector)\nuVector + \damping(\nuVector)\nuVector + \gravity(\etaVector) = \tauVector
\end{equation}
 
where
\begin{equation*}
  \listEta  
\end{equation*} are generalised positions and
\begin{equation*}
  \listNu 
\end{equation*}
are generalised velocities that are used to describe motion in 6 \abbrDOF. The matrices $\inertia$\index{Inertia matrix}, $\coriolis$\index{Coriolis matrix}, $\damping$\index{Damping matrix} and the vector $\gravity$\index{Restoring forces matrix} respectively describes how inertia, Coriolis forces, damping forces, gravity and buoyancy affect the \abbrROV. The vector $\tauVector$ describes the forces and torques produced by the \abbrROV's actuators and disturbances.
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In this chapter, the vector cross-product $\cross{\cdot}$ is defined as $\cross{a\boldsymbol{A}} \boldsymbol{B} = a\boldsymbol{A} \times \boldsymbol{B}$. The notation used for the parameters in this chapter and \Chapterref{cha:parameterEstimation} can be seen in \Tableref{tab:notationModelling}. The notation for forces, moments, linear and angular velocities, positions and Euler angles used in the model is summarised in \Tableref{tab:notationMarine}. 

 \begin{table}[tbp]
  \centering
  \caption{\label{tab:notationModelling}%
    The notation and description of the parameters used in the \abbrROV model.}

  \begin{tabular}{l p{0.7\linewidth}}
    \toprule%
    \textbf{Notation} & \textbf{Description} \\
    \otoprule%
    $\bodyinertia{b}$ & Inertia matrix for rotation around \abbrCO.\\
    $\bodyinertia{g}$ & Inertia matrix for rotation around \abbrCG.\\
    $\Kp, \Mq,\Nr$    & Linear damping coefficients for rotation in water. \\
    $\Kpabsp, \Mqabsq,\Nrabsr$ & Quadratic damping coefficients for rotation in water. \\
    $\Kpdot, \Mqdot,\Nrdot$    & Increased inertia about $\xPosition, \yPosition, \zPosition$-axis due to rotation in water.\\
    $\Xu, \Yv, \Zw$ & Linear damping coefficients for translation in water.\\
    $\Xuabsu, \Yvabsv, \Zwabsw$ & Quadratic damping coefficients for translation in water.\\
    $\Xudot, \Yvdot, \Zwdot$   & Added mass in $\xPosition, \yPosition, \zPosition$-direction due to translation in water. \\
    $\distance{x}{i}, \distance{y}{i},\distance{z}{i}$. & Moment arms from \abbrCG to each thruster $i$. \\
    $m$ & The \abbrROV's mass \\
    $z_B$ & Distance between \abbrCB and \abbrCG along the $z$-axis. \\
    $V$ & Displaced volume. \\
    $\rho$ & Water density. \\
    $g$ & Gravity. \\
    $r^g_b$ & The distance between \abbrCO and \abbrCG. \\
    \bottomrule%
  \end{tabular}
\end{table}

 \begin{table}[tbp]
  \centering
  \caption{\label{tab:notationMarine}%
    The notation of \citet{sname} for marine vessels.}

  \begin{tabular}{l p{0.35\linewidth}  p{0.14\linewidth} p{0.14\linewidth} p{0.14\linewidth}}
    \toprule%
    \textbf{DOF} & \textbf{Description}  & \textbf{Forces and moments} & \textbf{Linear and angular velocities} & \textbf{Positions and Euler angles} \\
    \otoprule%
    1 & Motions in the x direction (surge).     & \xForce       & \xVelocity        & \xPosition \\
        
    2 & Motions in the y direction (sway).      & \yForce       & \yVelocity        & \yPosition \\
    
    3 & Motions in the z direction (heave).     & \zForce       & \zVelocity        & \zPosition \\
    
    4 & Rotation about the x axis (roll, heel). & \rollMoment   & \rollVelocity     & \rollAngle \\
    
    5 & Rotation about the y axis (pitch, trim).& \pitchMoment  & \pitchVelocity    & \pitchAngle \\
    
    6 & Rotation about the z axis (yaw).        & \yawMoment    & \yawVelocity      & \yawAngle \\
    \bottomrule%
  \end{tabular}
\end{table}

To get a more compact way of writing a vector notation has been established
\begin{itemize}
\item $\boldsymbol{p}$: Positions.
\item $\boldsymbol{v}$: Linear velocities.
\item $\boldsymbol{\eulerAngles}$: Euler Angles.
\item $\boldsymbol{\quaternion}$: Quaternions.
\item $\boldsymbol{\omega}$: Angular velocities.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The body-fixed and global coordinate systems}
\label{sec:coordinates}\index{NED}\index{body-fixed coordinate system}\index{global coordinate system}
During modelling it is important to choose proper coordinate systems in which to describe the systems behaviour.
The \abbrROV model used in this thesis uses two separate coordinate systems.
The first system, the body-fixed coordinate system, is fixed to the \abbrROV and rotates with the \abbrROV. 
The body-fix coordinate system is a right-hand system, the $\xPosition$-axis is placed along the length of the \abbrROV pointing towards its bow. The $\yPosition$-axis points starboard, and the $\zPosition$-axis points downwards towards the vehicles keel. The coordinate system is assumed to be centred in the \abbrROV's \abbrCG. The body-fixed coordinate system makes it easier to describe sensor readings, since the sensors rotate with the \abbrROV. It is also easier to express the effect of each thruster in forces and moments described in the body-fixed coordinate system.

The global coordinate system is Earthfixed, with axes $\north$, $\east$ and $\down$. The $\north$ axis points in the direction of our calibrated North, the $\east$ axis points in the direction of calibrated East and the $\down$ axis points down towards the \abbrCG of the Earth.
This coordinate system is used to express buoyancy and gravitational forces on the \abbrROV, their effects are transformed to the local coordinate system by a rotation matrix. How the local and global coordinate systems relate to each other can be seen in \Figureref{fig:coordinate_frames}.

\newcommand*{\coordinateRadius}{0.05}
\newcommand*{\coordRot}{30}
\begin{figure}
    \centering
    \begin{tikzpicture}[scale=2]
        \pgfmathsetmacro\by{\coordinateRadius*sin(45)}
        \pgfmathsetmacro\bx{\coordinateRadius*cos(45)}
        \pgfmathsetmacro\ay{\coordinateRadius*sin(\coordRot)}
        \pgfmathsetmacro\ax{\coordinateRadius*cos(\coordRot)}
        \pgfmathsetmacro\coordYRot{sin(\coordRot)}
        \pgfmathsetmacro\coordXRot{cos(\coordRot)}
        
        \coordinate (O) at (0,0);
        \draw[thick,->] (O) ++(\coordinateRadius,0) -- ++(1,0) node[anchor=north east]{$\north$};
        \draw[thick,->] (O) ++(0,-\coordinateRadius)-- ++(0,-1) node[anchor=south east]{$\east$};
        \draw (O) circle (0.05) node[anchor=south,]{$\down$,\color{red}$\zPosition$};
        \draw (O) -- ++(\bx,\by) (O) -- ++(-\bx,-\by) (O) -- ++(-\bx,\by) (O)  -- ++(\bx,-\by);
        
        \draw[thick,red,->] (O) ++(\ax,-\ay) -- ++(\coordXRot,-\coordYRot) node[anchor=north west]{$\xPosition$};
        \draw[thick,red,->] (O) ++(-\ay,-\ax) -- ++(-\coordYRot,-\coordXRot) node[anchor=north east]{$\yPosition$};
        \draw[->] (O) ++(0.5,0) arc (0:-\coordRot:0.5) node[right]{\yawAngle};
        
        \def\coordDistance{1.5}
        
         \coordinate (O) at (\coordDistance,0);
         \draw[thick,->] (O) ++(\coordinateRadius,0) -- ++(1,0) node[anchor=north east]{$\north$};
         \draw[thick,->] (O) ++(0,-\coordinateRadius)-- ++(0,-1) node[anchor=south east]{$\down$};
         \draw (O) circle (0.05) node[anchor=south,]{$\east$,\color{red}$\yPosition$};
         \draw[fill=black] (O) circle (0.0125);
        
         \draw[thick,red,->] (O) ++(\ax,\ay) -- ++(\coordXRot,\coordYRot) node[anchor=south west]{$\xPosition$};
         \draw[thick,red,->] (O) ++(\ay,-\ax) -- ++(\coordYRot,-\coordXRot) node[anchor=north east]{$\zPosition$};
         \draw[->] (O) ++(0.5,0) arc (0:\coordRot:0.5) node[right]{\pitchAngle};
         
          
        \pgfmathsetmacro\coordDistanceZ{2*\coordDistance+1}
        
         \coordinate (O) at (\coordDistanceZ,0);
         \draw[thick,->] (O) ++(-\coordinateRadius,0) -- ++(-1,0) node[anchor=north west]{$\east$};
         \draw[thick,->] (O) ++(0,-\coordinateRadius) -- ++(0,-1) node[anchor=south east]{$\down$};
         \draw (O) circle (0.05) node[anchor=south,]{$\north$,\color{red}$\xPosition$};
         \draw[fill=black] (O) circle (0.0125);
        
        \draw[thick,red,->] (O) ++(\ay,-\ax) -- ++(\coordYRot,-\coordXRot) node[anchor=north west]{$\zPosition$};
        \draw[thick,red,->] (O) ++(-\ax,-\ay) -- ++(-\coordXRot,-\coordYRot) node[anchor=south east]{$\yPosition$};
        \draw[->] (O) ++(-0.5,0) arc (180:180+\coordRot:0.5) node[left]{\rollAngle};
    
    \end{tikzpicture}
    \caption{The local and global coordinate systems relate to each other by the rotations \yawAngle, \pitchAngle and \rollAngle. The rotations are defined from the global coordinate system (black) to the body-fixed coordinate system (red).} 
    \label{fig:coordinate_frames}
\end{figure}

\missingfigure{Picture of the rov with the coordinate system.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Kinetics} \index{Kinetics}\index{Transformation matrices}
The relationship between the body-fixed frame and the global frame can be described by different transformation matrices.
The transformation for linear velocities from the body-fixed coordinate system to the global coordinate system is according to \citet[22]{fossen2011} 
\begin{equation}
\linVelGlobal = \boldsymbol{R}^n_b(\eulerAngles) \linVelBody
\end{equation}
where the transformation matrix $\boldsymbol{R}^n_b(\eulerAngles)$ in $zyx$ convention is 
\begin{equation}
\boldsymbol{R}^n_b(\eulerAngles) =\begin{bmatrix}
 c\yawAngle c\pitchAngle & -s\yawAngle c\rollAngle + c\yawAngle s\pitchAngle s\rollAngle & s\yawAngle s\rollAngle + c\yawAngle c\rollAngle s \pitchAngle \\
 s\yawAngle c\pitchAngle & c\yawAngle c\rollAngle + s\rollAngle  s\pitchAngle s\yawAngle & -c\yawAngle s\rollAngle + s\pitchAngle s\yawAngle c\rollAngle \\
 -s\pitchAngle & c\pitchAngle s\rollAngle & c\pitchAngle c\rollAngle
 \end{bmatrix} 
\end{equation}
where $s$ stands for $\sin$ and $c$ stands for $\cos$. The inverse of the transformation matrix $\boldsymbol{R}^n_b(\eulerAngles)$ is
\begin{equation}
\boldsymbol{R}^n_b(\eulerAngles)^{-1} = \boldsymbol{R}^n_b(\eulerAngles)^T
\end{equation}

Angular velocities transformation between the from the body-fixed frame to the global frame is given by 
\begin{equation}
\eulerAnglesdot = \boldsymbol{T}_{\theta}(\eulerAngles)\angVelBody
\end{equation}
where $\boldsymbol{T}_{\theta}(\eulerAngles)$ is 
\begin{equation}
\boldsymbol{T}_{\theta}(\eulerAngles) = \begin{bmatrix}
1 & s\rollAngle t\pitchAngle & c\rollAngle t\pitchAngle \\
0 & c\rollAngle & -s\rollAngle \\
0 & s\rollAngle/c\pitchAngle & c\rollAngle/c\pitchAngle
\end{bmatrix}
\end{equation}
where $t$ stands for $\tan$ \citep[24-25]{fossen2011}. Similar to the linear velocities transformation matrix is the inverse of the angular velocities transformation matrix
\begin{equation}
\boldsymbol{T}_{\theta}(\eulerAngles)^{-1} = \boldsymbol{T}_{\theta}(\eulerAngles)^T
\end{equation}

The kinematic equations can then be expressed in vector form as \index{Kinematics}
\begin{equation} 
\etaVectordot = \boldsymbol{J}_\theta(\etaVector)\nuVector
\Leftrightarrow
\begin{bmatrix}
\posGlobaldot \\
\eulerAnglesdot
\end{bmatrix}
=
\begin{bmatrix}
\boldsymbol{R}^n_b(\eulerAngles) & \zero{3} \\
\boldsymbol{0}_{4x3} & \boldsymbol{T}_\theta(\eulerAngles)
\end{bmatrix}
\begin{bmatrix}
\linVelBody \\
\angVelBody
\end{bmatrix}
\end{equation} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Inertia}
The inertia matrix $\inertia$ describes the resistance of moving and rotating the \abbrROV in its 6 \abbrDOF. It also describes the added mass that comes from rotating and translating a body in a liquid media. The inertia matrix is defined as
\begin{equation}
    \inertia = \inertia_{RB}+\inertia_{A}
\end{equation}
where $\inertia_{RB}$ is the inertia Matrix for a rigid-body and $\inertia_{A}$ is the added mass \citep{fossen2011}.\index{Added mass} \index{Inertia}

The inertia matrix, $\inertia_{RB}$, for a rigid-body is defined as
\begin{equation}
\label{eq:inertia}
    \inertia_{RB} = 
    \begin{pmatrix}
    m\eye{3}       & -m\cross{r^b_g} \\
    m\cross{r^b_g} & \bodyinertia{b}
    \end{pmatrix}
\end{equation}
where $r^b_g$ is the distance between the \abbrROV's \abbrCO and \abbrCG \citep[p.52]{fossen2011}.
It has been assumed that the \abbrROV's \abbrCO and \abbrCG coincide, thus simplifying \eqref{eq:inertia} to
\begin{equation}
   \inertia_{RB} = 
    \begin{pmatrix}
        m\eye{3} & \zero{3} \\
        \zero{3} & \bodyinertia{g}
    \end{pmatrix}
\end{equation} 
The added mass of the water, $\inertia_A$, acting upon the \abbrROV is defined as
\begin{equation}
\inertia_A =
-\begin{pmatrix}
    \Xudot & 0 & 0 & 0 & 0 & 0 \\
    0 & \Yvdot & 0 & 0 & 0 & 0 \\
    0 & 0 & \Zwdot & 0 & 0 & 0 \\
    0 & 0 & 0 & \Kpdot& 0 & 0 \\
    0 & 0 & 0 & 0 & \Mqdot & 0 \\
    0 & 0 & 0 & 0 & 0 & \Nrdot \\
    \end{pmatrix}
\end{equation}
under the assumption that the \abbrROV moves at low speeds relative to the water \citep[p.121]{fossen2011}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coriolis forces}
Since the \abbrROV travels in a rotating reference frame, the Earth, the \abbrROV is subjected to inertial forces called Coriolis forces. The Coriolis forces acting on the \abbrROV are described in a similar manner to the inertia matrix, $\inertia$, with
\begin{equation}
    \coriolis(\nuVector) = \coriolis_{RB}(\nuVector) + \coriolis_A(\nuVector)
\end{equation}\citep[p.110]{fossen2011}. $\coriolis_{RB}(\nuVector)$ describes the Coriolis and centripetal forces caused by the rigid body's mass, while $\coriolis_A(\nuVector)$ describe the same effects but caused by the added inertia and mass.\index{Added mass}\index{Coriolis}

The rigid-body Coriolis vector is given as
\begin{equation}
\begin{split}
    \coriolis_{RB}(\nuVector)\nuVector &= 
    \begin{pmatrix}
        m\cross{\nuVectorAng}              & -m\cross{\nuVectorAng}\cross{r_g^b}  \\
        m\cross{r_g^b}\cross{\nuVectorAng} & -\cross{\bodyinertia{b}\nuVectorAng} \\
    \end{pmatrix}
    \nuVector = 
    \begin{pmatrix}
    m (q w-r v) \\
    m (r u-p w) \\
    m (p v-q u) \\
    q r(\bodyinertiaconstant{y}-\bodyinertiaconstant{z}) \\
    r p(\bodyinertiaconstant{z}-\bodyinertiaconstant{x}) \\
    q p(\bodyinertiaconstant{x}-\bodyinertiaconstant{y}) \\
    \end{pmatrix}
\end{split}
\end{equation}
where it has been assumed that the \abbrROV is symmetric about the $xyz$-plane to eliminate cross-terms in $\coriolis(\nuVector)$\citep[p.55]{fossen2011}.
The Coriolis and centripetal effects from the added mass are described as
\begin{equation}
\begin{split}
    \coriolis_A(\nuVector) \nuVector &= 
    \begin{pmatrix}
    0 & 0 & 0 & 0 & -\Zwdot w & \Yvdot v \\
    0 & 0 & 0 & \Zwdot w & 0 & -\Xudot u \\
    0 & 0 & 0 & -\Yvdot v & \Xudot u & 0 \\
    0 & -\Zwdot w & \Yvdot v & 0 & -\Nrdot r & \Mqdot q \\
    \Zwdot w & 0 & -\Xudot u & \Nrdot r & 0 & -\Kpdot p \\
    -\Yvdot v & \Xudot u & 0 & - \Mqdot q & \Kpdot p & 0 \\
    \end{pmatrix}
    \nuVector = \\ 
    &= \begin{pmatrix}
        \Yvdot v r - \Zwdot w q\\
        \Zwdot w p - \Xudot u r\\
        \Xudot u q - \Yvdot v p \\
        (\Yvdot - \Zwdot) v w + (\Mqdot - \Nrdot) q r\\
        (\Zwdot - \Xudot) u w + (\Nrdot - \Kpdot) p r\\
        (\Xudot - \Yvdot) u v + (\Kpdot - \Mqdot) p q \\
    \end{pmatrix}
\end{split}
\end{equation} Under the assumption that the \abbrROV is moving slowly and has three planes of symmetry \citep[p.121]{fossen2011}. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Viscous damping}
There are four main sources of hydrodynamic damping acting upon a submersed vehicle \citep[p.122]{fossen2011}.
Potential damping, skin friction, wave drift damping and damping from vortex shedding. The effects of these four sources on a 6 \abbrDOF vehicle can be described by two 6-by-6 matrices.\index{Viscous damping}
The matrix $\damping$ contains the linear damping terms, while the matrix $\damping_{n}(\nuVector)$ contains the quadratic, or non-linear, damping terms \citep{fossen2011}. The sum of these two matrices form the Viscous damping matrix $\damping(\nuVector)$ which in turn can be simplified to
\begin{equation}
\begin{split}
    \damping(\nuVector) &= \damping + \damping_{n}(\nuVector) = \\
    -& \scalemath{0.7}{\begin{pmatrix}
        \Xu+\Xuabsu\abs{u} & 0 & 0 & 0 & 0 & 0 \\
        0 & \Yv+\Yvabsv\abs{v} & 0 & 0 & 0 & 0 \\
        0 & 0 & \Zw+\Zwabsw\abs{w} & 0 & 0 & 0 \\
        0 & 0 & 0 & \Kp+\Kpabsp\abs{p} & 0 & 0 \\
        0 & 0 & 0 & 0 & \Mq+\Mqabsq\abs{q} & 0 \\
        0 & 0 & 0 & 0 & 0 & \Nr+\Nrabsr\abs{r} \\
    \end{pmatrix}}
\end{split}
\end{equation}
If the \abbrROV is symmetric about the $xz$-plane and the damping is assumed to be decoupled, $\damping(\nuVector)$ is a diagonal matrix \citep[p.129-130]{fossen2011}. The following vector is obtained when $\damping(\nuVector)$ is multiplied with $\nuVector$
\begin{equation}
    \damping(\nuVector) \nuVector =
     -\begin{pmatrix}
    (\Xu + \Xuabsu \abs{u}) u\\
    (\Yv + \Yvabsv \abs{v}) v\\
    (\Zw + \Zwabsw \abs{w}) w\\
    (\Kp + \Kpabsp \abs{p}) p\\
    (\Mq + \Mqabsq \abs{q}) q\\
    (\Nr + \Nrabsr \abs{r}) r\\
    \end{pmatrix}    
\end{equation}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Restoring forces}\index{Restoring forces}\index{buoyancy}
Since the \abbrROV is submerged it will experience forces and moments caused by the Earths gravitational pull and the buoyancy force, in hydrostatic terms these are called restoring forces and act as spring forces on the \abbrROV \citep{fossen2011}. The restoring forces and moments are calculated using four main parameters; the mass of the vehicle, $m$, its buoyancy $B$ and lastly the coordinates for the \abbrROV's \abbrCG and center of buoyancy (\abbrCB) \citep{fossen2011}. The restoring forces vector, $\gravity(\etaVector)$, describes how the forces and moments caused by the buoyancy force and gravitational pull of the Earth act on a 6 \abbrDOF model.It is according to \citet[p.60]{fossen2011} defined as
\begin{equation} \label{eq:restoring_forces}
    \gravity(\etaVector) =
     \begin{pmatrix}
    \boldsymbol{f}_g + \boldsymbol{f}_b \\
    \boldsymbol{r}_b \times \boldsymbol{f}_b + \boldsymbol{r}_g \times \boldsymbol{f}_g) 
     \end{pmatrix} 
     =
    \begin{pmatrix}
        (W - B) \sin \pitchAngle\\
    -(W - B) \cos \pitchAngle \sin \rollAngle\\
    -(W - B) \cos \pitchAngle \sin \rollAngle\\
    -z_B B \cos \pitchAngle \sin \rollAngle\\
    -z_B B \sin \pitchAngle\\
    0\\
    \end{pmatrix}
\end{equation}
where $\boldsymbol{r}_b = [0, 0, z_B]^T$, $\boldsymbol{r}_g = [0, 0, 0]^T$, $\boldsymbol{f}_g = \boldsymbol{R}^n_b(\eulerAngles)^T [0, 0, W]^T$ and $\boldsymbol{f}_b = -\boldsymbol{R}^n_b(\eulerAngles)^T [0, 0, B]^T$.
Here $B$ is given by $B = \rho g V$ and $W = m g$. $m$ is the \abbrROV's mass, $g$ the gravitational constant, $\rho$ the density of water and $V$ the volume of displaced water. In other words the magnitude of the buoyancy forces is equal to the weight of the displaced water. For a fully submerged vehicle, $V$ will naturally be equal the volume of the vehicle.
In these calculations it is assumed that the \abbrCG coincides with the \abbrCO and that the \abbrCB lies at coordinate $[0, 0, z_B]$, directly above or below the \abbrCO. Note that the positions of the three centers are described using the coordinate system described in \Sectionref{sec:coordinates}, a roll and pitch stable \abbrROV should thus have a $z_B < 0$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Thrust Matrix}
\missingfigure{Picture of the moments and forces including the name of the thrusters.}
The \abbrROV's actuators can be modelled as
\begin{equation}
    \tauVector = \thrusterGeometry \boldsymbol{\thrusterfun{}} 
\end{equation}
where $\thrusterGeometry$\index{thruster geometry} is a matrix describing the geometry of the actuators, see \Figureref{fig:thrusterlocationtop} \citep[p.401]{fossen2011}.
\begin{equation}
\begin{split}
    \tauVector = \thrusterGeometry \boldsymbol{\thrusterfun{}} 
    &=
    \begin{pmatrix}
    0& 0& 1& 1& 0& 0\\
    0& 0& 0&  0& 0& -1\\
    -1& -1& 0& 0& -1& 0\\
    \distance{y}{1} & -\distance{y}{2} & 0 &  0 &  0 & \distance{z}{6} \\
    \distance{x}{1} & \distance{x}{2} & 0 & 0 & -\distance{x}{5} & 0 \\
    0 & 0 & \distance{y}{3} & -\distance{y}{4} & 0 & 0 \\
    \end{pmatrix}
    \begin{pmatrix}
    \thrusterfun{1} \\
    \thrusterfun{2} \\
    \thrusterfun{3} \\
    \thrusterfun{4} \\
    \thrusterfun{5} \\
    \thrusterfun{6} \\
    \end{pmatrix}
    = \\
    &=\begin{pmatrix}
     \thrusterfun{3} + \thrusterfun{5} g \\
     -\thrusterfun{6} \\
     -\thrusterfun{1} - \thrusterfun{2} - \thrusterfun{4} \\
    \thrusterfun{2} \distance{y}{2} - \thrusterfun{1} \distance{y}{1} + \thrusterfun{6} \distance{z}{6} \\
    \thrusterfun{2} \distance{x}{2} - \thrusterfun{1} \distance{x}{1} - \thrusterfun{4} \distance{x}{4} \\
    \thrusterfun{3} \distance{y}{3} - \thrusterfun{5} \distance{y}{5} \\
    \end{pmatrix}
\end{split}
\end{equation}
where \distance{x}{1}, \distance{x}{2}, \distance{y}{1}, \distance{y}{2}, \distance{y}{3}, \distance{y}{4} and \distance{z}{6} are the offsets in the $x$, $y$ or $z$ direction of the $n$:th thruster and $\thrusterfun{i}$ is a lookup table from control signal to thrust in Newtons. See \appref{app:thrustmapping} for details regarding the lookup table.

\begin{figure}
\centering 
\begin{tikzpicture}
    \node[anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[trim={28cm 0cm 22cm 5cm},clip,width=0.9\textwidth]{thrusterlocationtop}};
    \begin{scope}[x={(image.south east)},y={(image.north west)}]
		\pgfmathsetmacro\coordinateRadius{0.025}
        \pgfmathsetmacro\by{\coordinateRadius*sin(45)}
        \pgfmathsetmacro\bx{\coordinateRadius*cos(45)}
        \pgfmathsetmacro\ay{\coordinateRadius*sin(\coordRot)}
        \pgfmathsetmacro\ax{\coordinateRadius*cos(\coordRot)}
        \pgfmathsetmacro\coordYRot{sin(\coordRot)}
        \pgfmathsetmacro\coordXRot{cos(\coordRot)}
        
        \coordinate (O) at (0.48,0.52);
        \draw[red, thick,->] (O) ++(\coordinateRadius,0) -- ++(0.4,0) node[anchor=north east]{\color{red}$\xPosition$};
        \draw[red, thick,->] (O) ++(0,-\coordinateRadius)-- ++(0,-0.4) node[anchor=south east]{\color{red}$\yPosition$};
        \draw[red, thick] (O) circle (\coordinateRadius) node[anchor=south,]{\color{red}$\zPosition$};
        \draw[red, thick] (O) -- ++(\bx,\by) (O) -- ++(-\bx,-\by) (O) -- ++(-\bx,\by) (O)  -- ++(\bx,-\by);
        
        \draw[yellow, thick, <->] (O) ++(0.34,0) -- ++(0,0.23)  node [midway, left] {\distance{y}{1}};
        \draw[yellow, thick, <->] (O) ++(0.34,0) -- ++(0,-0.28) node [midway, left] {\distance{y}{2}};
        \draw[yellow, thick, <->] (O) ++(0.03,0) -- ++(0,0.24)  node [midway, right] {\distance{y}{3}};
        \draw[yellow, thick, <->] (O) ++(0.03,0) -- ++(0,-0.28) node [midway, right] {\distance{y}{4}};
        
        \draw[yellow, thick, <->] (O) ++(0,0.27) -- ++(0.34,0)  node [midway, below] {\distance{x}{1}};
        \draw[yellow, thick, <->] (O) ++(0,-0.32) -- ++(0.34,0)  node [midway, below] {\distance{x}{2}};
        \draw[yellow, thick, <->] (O) -- ++(-0.30,0)  node [midway, below] {\distance{x}{5}};
    \end{scope}
\end{tikzpicture}
    \caption{.}
    \label{fig:thrusterlocationtop}
\end{figure}

\begin{figure}
\centering 
\begin{tikzpicture}
    \node[anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[trim={0cm 0cm 0cm 0cm},clip,width=0.9\textwidth]{thrusterlocationfront}};
    \begin{scope}[x={(image.south east)},y={(image.north west)}]
		\pgfmathsetmacro\coordinateRadius{0.025}
        \pgfmathsetmacro\by{\coordinateRadius*sin(45)}
        \pgfmathsetmacro\bx{\coordinateRadius*cos(45)}
        \pgfmathsetmacro\ay{\coordinateRadius*sin(\coordRot)}
        \pgfmathsetmacro\ax{\coordinateRadius*cos(\coordRot)}
        \pgfmathsetmacro\coordYRot{sin(\coordRot)}
        \pgfmathsetmacro\coordXRot{cos(\coordRot)}
        
        \coordinate (O) at (0.48,0.52);
        \draw[red, thick,->] (O) ++(\coordinateRadius,0) -- ++(0.4,0) node[anchor=north east]{\color{red}$\xPosition$};
        \draw[red, thick,->] (O) ++(0,-\coordinateRadius)-- ++(0,-0.4) node[anchor=south east]{\color{red}$\yPosition$};
        \draw[red, thick] (O) circle (\coordinateRadius) node[anchor=south,]{\color{red}$\zPosition$};
        \draw[red, thick] (O) -- ++(\bx,\by) (O) -- ++(-\bx,-\by) (O) -- ++(-\bx,\by) (O)  -- ++(\bx,-\by);
        
        \draw[yellow, thick, <->] (O) ++(0.34,0) -- ++(0,0.23)  node [midway, left] {\distance{y}{1}};
        \draw[yellow, thick, <->] (O) ++(0.34,0) -- ++(0,-0.28) node [midway, left] {\distance{y}{2}};
        \draw[yellow, thick, <->] (O) ++(0.03,0) -- ++(0,0.24)  node [midway, right] {\distance{y}{3}};
        \draw[yellow, thick, <->] (O) ++(0.03,0) -- ++(0,-0.28) node [midway, right] {\distance{y}{4}};
        
        \draw[yellow, thick, <->] (O) ++(0,0.27) -- ++(0.34,0)  node [midway, below] {\distance{x}{1}};
        \draw[yellow, thick, <->] (O) ++(0,-0.32) -- ++(0.34,0)  node [midway, below] {\distance{x}{2}};
        \draw[yellow, thick, <->] (O) -- ++(-0.30,0)  node [midway, below] {\distance{x}{5}};
    \end{scope}
\end{tikzpicture}
    \caption{.}
    \label{fig:thrusterlocationfront}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Equations in Component Form}
If the matrices and vectors in \eqref{eq:model} are substituted with the matrices and vectors previously defined in this chapter and \eqref{eq:model} then solved for $\nuVectordot$ the following equations can be derived 
\begin{multline} \label{eq:u_dot}
\dot{u} = \frac{\thrusterfun{3} + \thrusterfun{4}}{m -\Xudot} + \frac{u (\Xu + \Xuabsu \abs{u})}{m -\Xudot} + \frac{\sin(\theta)(B - W)}{m -\Xudot} +\\
\frac{m(r v - q w )}{m -\Xudot} + \frac{-\Yvdot r v}{m -\Xudot} + \frac{\Zwdot q w}{m -\Xudot},
\end{multline}
\begin{multline} \label{eq:v_dot}
\dot{v} = \frac{-\thrusterfun{6}}{m - \Yvdot} + \frac{v (\Yv + \Yvabsv \abs{v})}{m - \Yvdot} + \frac{-\cos{\theta} \sin{\phi}(B - W)}{m - \Yvdot} +\\ \frac{m(p w - r u)}{m - \Yvdot} + \frac{\Xudot r u}{m - \Yvdot} + \frac{-\Zwdot p w}{m - \Yvdot},
\end{multline}
\begin{multline} \label{eq:w_dot}
\dot{w} = \frac{-\thrusterfun{1} - \thrusterfun{2} - \thrusterfun{5}}{m - \Zwdot} + \frac{w (\Zw + \Zwabsw \abs{w})}{m - \Zwdot} + \frac{-\cos{\phi}\cos{\theta}(B - W)}{m - \Zwdot} +\\
\frac{m (q u - p v)}{m - \Zwdot} + \frac{-\Xudot q u}{m - \Zwdot} + \frac{\Yvdot p v}{m - \Zwdot},
\end{multline}
\begin{multline} \label{eq:p_dot}
\dot{p} = \frac{\thrusterfun{1} \distance{y}{1} - \thrusterfun{2} \distance{y}{2} + \thrusterfun{6} \distance{z}{6}}{\Ix - \Kpdot} + \frac{p (\Kp + \Kpabsp \abs{p})}{\Ix - \Kpdot} + \frac{-\Mqdot q r}{\Ix - \Kpdot} + \frac{\Nrdot q r}{\Ix - \Kpdot} +\\
\frac{q r (\Iy - \Iz)}{\Ix - \Kpdot} + \frac{- \Yvdot v w}{\Ix - \Kpdot} + \frac{\Zwdot v w}{\Ix - \Kpdot} + \frac{B \cos{\theta} \sin{\phi} z_B}{\Ix - \Kpdot},
\end{multline}
\begin{multline} \label{eq:q_dot}
\dot{q} =\frac{\thrusterfun{1} \distance{x}{1} + \thrusterfun{2} \distance{x}{2} - \thrusterfun{5} \distance{x}{5}}{\Iy - \Mqdot} + \frac{q (\Mq + \Mqabsq \abs{q})}{\Iy - \Mqdot} + \frac{\Kpdot p r}{\Iy - \Mqdot} + \frac{-\Nrdot p r}{\Iy - \Mqdot} +\\
\frac{p r (\Iz - \Ix)}{\Iy - \Mqdot} + \frac{-\Zwdot u w}{\Iy - \Mqdot} + \frac{\Xudot u w}{\Iy - \Mqdot} + \frac{B \sin{\theta} z_B}{\Iy - \Mqdot} 
\end{multline} and 
\begin{multline} \label{eq:r_dot}
\dot{r} = \frac{\thrusterfun{3} \distance{y}{3} - \thrusterfun{4} \distance{y}{4}}{\Iz - \Nrdot} + \frac{r (\Nr + \Nrabsr \abs{r})}{\Iz - \Nrdot} + \frac{-\Kpdot p q}{\Iz - \Nrdot} + \frac{\Mqdot p q}{\Iz - \Nrdot} +\\
\frac{p q (\Ix - \Iy)}{\Iz - \Nrdot} + \frac{- \Xudot u v}{\Iz - \Nrdot} + \frac{\Yvdot u v}{\Iz - \Nrdot}
\end{multline} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Quaternions} \index{Quaternions} \index{Transformation matrices}
Unit quaternions $\quaternion$ are a useful way to express angles. Where Euler angel representations are singular the corresponding quaternion representations are not. To use quaternions instead of Euler angles, $\etaVector$ has to be changed to 
\begin{equation}
\etaVector = \begin{pmatrix}
\north \\
\east \\
\down \\
\quatO \\
\quatI \\
\quatII \\
\quatIII \\
\end{pmatrix}
\end{equation}
and the transformation matrix from body-fixed coordinates to global coordinates is given by 
\begin{equation}
\boldsymbol{R}^n_b(\quaternion) = \begin{pmatrix}
  1 - 2(\quatII^2 + \quatIII^2) & 2(\quatI\quatII - \quatIII\quatO)   & 2(\quatI\quatIII + \quatII\quatO) \\
     2(\quatI\quatII + \quatIII\quatO) &  1-2(\quatI^2 + \quatIII^2) & 2(\quatII\quatIII-\quatI\quatO)    \\
     2(\quatI\quatIII - \quatII\quatO) &  2(\quatII\quatIII + \quatI\quatO)  & 1-2(\quatI^2 + \quatII^2) \\
\end{pmatrix}
\end{equation}

Changing to quaternions changes \eqref{eq:restoring_forces} to 
\begin{equation}
    \boldsymbol{g}(\etaVector) = 
    \begin{pmatrix}
    \boldsymbol{f}_g + \boldsymbol{f}_b \\
    \boldsymbol{r}_b \times \boldsymbol{f}_b + \boldsymbol{r}_g \times \boldsymbol{f}_g) 
     \end{pmatrix} = 
    \begin{pmatrix}
	(B - W) (2 \quatI \quatIII - 2 \quatII \quatO) 	\\
    (B - W) (2 \quatII \quatIII + 2 \quatI \quatO) 	\\
 	(W - B)(2 \quatI^2 + 2\quatII^2 - 1)				\\
 	-B z_B (2 \quatII \quatIII + 2 \quatI \quatO)	\\
  	B z_B (2 \quatI \quatIII - 2 \quatII \quatO)		\\
    0
    \end{pmatrix}
\end{equation}

A unit quaternion satisfies $\quaternion^T\quaternion = 1$, thus does the quaternions need normalisation.
Quaternion normalisation in continuous time is given by 
\begin{equation}
\quaterniondot = \boldsymbol{T}_q(\quaternion) \angVelBody + \frac{\gamma}{2} ( 1 - \quaternion^T\quaternion)\quaternion
\end{equation}
according to \citet[31]{fossen2011}. $\gamma$ is a design variable, $\gamma \geq 0$ usually $\gamma = 100$, indicating the convergence rate of the normalisation and $\boldsymbol{T}_q(\quaternion)$ is given by
\begin{equation} \label{eq:Tquat}
\boldsymbol{T}_q(\quaternion) = \frac{1}{2}
\begin{pmatrix}
-\quatI  & -\quatII  & -\quatIII \\
\quatO   & -\quatIII & \quatII \\
\quatIII & \quatO    &  -\quatI \\
-\quatII & \quatI    & \quatO \\
\end{pmatrix}
\end{equation}

In discrete time quaternion normalisation is given by 
\begin{equation}
\quaternion(k+1) = \frac{\quaternion(k+1)}{\sqrt{\quaternion^T(k+1)\quaternion(k+1)}}
\end{equation}

The kinematic equations are changed to \index{Kinematics}
\begin{equation}
\etaVectordot = \boldsymbol{J}_q(\etaVector)\nuVector
\Leftrightarrow
\begin{bmatrix}
\posGlobaldot \\
\quaterniondot
\end{bmatrix}
=
\begin{bmatrix}
\boldsymbol{R}^n_b(\quaternion) & \zero{3} \\
\boldsymbol{0}_{4x3} & \boldsymbol{T}_q(\quaternion)
\end{bmatrix}
\begin{bmatrix}
\linVelBody \\
\angVelBody
\end{bmatrix}
\end{equation}  